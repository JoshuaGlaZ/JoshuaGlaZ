name: Yearly Progress Bar

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */8 * * *" # Runs every 8 hours

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Calculate Progress & Update README
        shell: python
        run: |
          import os
          import re
          from datetime import datetime, timezone

          now = datetime.now(timezone.utc)
          start_of_year = datetime(now.year, 1, 1, tzinfo=timezone.utc)
          end_of_year = datetime(now.year + 1, 1, 1, tzinfo=timezone.utc)
          progress = (now - start_of_year) / (end_of_year - start_of_year)
          
          length = 22
          filled_len = int(progress * length)
          bar = "â–“" * filled_len + "â–‘" * (length - filled_len)
          upper = "â–›" + "â–”" * (length - 1)
          bottom = " " * length + "â–ž"
          percent_str = f"{progress * 100:.2f}%"
          date_str = now.strftime('%a, %d %b %Y %H:%M:%S')
          
          ascii_art = f"""```text
          '
          '     ___       __      ___    ______    
          '   /'___`\\   /'__`\\  /'___`\\ /\\  ___\\   
          '  /\\_\\ /\\ \\ /\\ \\/\\ \\/\\_\\ /\\ \\\\ \\ \\__/      {upper}
          '  \\/_/// /__\\ \\ \\ \\ \\/_/// /__\\ \\___``\\         {bar} {percent_str}
          '     // /_\\ \\\\ \\ \\_\\ \\ // /_\\ \\\\/\\ \\L\\ \\   {bottom}
          '    /\\______/ \\ \\____//\\______/ \\ \\____/
          '    \\/_____/   \\/___/ \\/_____/   \\/___/ 
          '                                                                         ðŸ“¢ Updated on {date_str} UTC 
          '
          ```"""

          readme_path = "README.md"
          if os.path.exists(readme_path):
              with open(readme_path, "r", encoding="utf-8") as f:
                  content = f.read()

              pattern = r"()(.*?)()"
              replacement = f"\\1\n{ascii_art}\n\\3"
              
              if re.search(pattern, content, re.DOTALL):
                  new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                  with open(readme_path, "w", encoding="utf-8") as f:
                      f.write(new_content)
                  print("README updated successfully.")
              else:
                  print("Error: Markers not found in README.")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"commit_message=Update progress to {percent_str}\n")

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          # Only commit if there are changes
          git diff --staged --quiet || git commit -m "${{ steps.update.outputs.commit_message }}"
          git push